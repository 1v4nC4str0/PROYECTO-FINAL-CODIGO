<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>ABM Historia</title>
    <link rel="stylesheet" href="view/css/abm.css">
    <link rel="stylesheet" href="view/css/4abm.css">
</head>

<body>
    <div class="contenedor-gral">
        <div class="banner">
            <div class="logo">
                <img src="view/img/logomasEsic.png" alt="">
            </div>
            <div class="espacio"></div>
            <div class="botones-inicio-notificar">
                <a href="index.html"><button class="boton-banner">INICIO</button></a>
                <button class="boton-banner" onclick="navegar('notificar_general.php')">NOTIFICAR</button>
            </div>
        </div>
        <div class="elemento-arriba">
            <div class="componente"></div>
            <div class="rectangulo-vertical"></div>
        </div>
        <div class="nombre">
            HISTORIAS
        </div>
        <div class="contenedor">
            <div class="cuerpo">
                <div class="boton-alta">
                    <button id="boton-alta" onclick="monstrarPopupAlta()" class="botones">ALTA</button>
                </div>
                <div class="entradas">

                    <input class="inputs" type="text" id="id" name="id" placeholder="ID">
                    <input class="inputs" type="text" id="nombre" name="nombre" placeholder="NOMBRE">
                    <input class="inputs" type="text" id="desc" name="desc" placeholder="DESCRIPCION">
                    <select class="inputs" name="act_id" id="act_id"></select>

                    <button class="lupa" onclick="buscarHistoria()"><span
                            class="material-symbols-outlined">search</span></button>
                </div>
                <div class="tabla">
                    <table id="tabla">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkTodos" onclick="selectAll()"></th>
                                <th class="col-id">ID</th>
                                <th class="col-nombre">NOMBRE</th>
                                <th class="col-desc">DESCRIPCION</th>
                                <th class="col-img">FOTO DE LA HISTORIA</th>
                                <th class="col-act">ACTIVIDAD ASOCIADA</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpo">
                        </tbody>

                    </table>
                    <!-- <div id="errorTabla">No hay resultados</div> -->
                </div>
                <div class="botones-baja-modificacion">
                    <button class="botones" onclick="mostrarPopupBaja()" id="boton-baja">BAJA</button>
                    <button class="botones" onclick="mostrarPopupMod()" id="boton-modificar">MODIFICAR</button>
                </div>

            </div>
        </div>
        <div class="elemento-abajo" id="doss">
            <div class="componente" id="dos"></div>
            <div class="rectangulo-vertical"></div>
        </div>

    </div>
    <div id="popup-alta" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">ALTA</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupAlta()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div id="contenido-popup">
                        <div class="entradas-popup">
                            <label class="label-popup" for="nombre-popup">NOMBRE</label>
                            <input class="inputs-popup" type="text" id="nombre-popup" name="nombre-popup">
                            <label class="label-popup" for="desc-popup">DESCRIPCION</label>
                            <input class="inputs-popup" type="text" name="desc-popup" id="desc-popup"></input>
                            <label class="label-popup" for="foto-popup">FOTO</label>
                            <input class="inputs-popup" type="text" name="foto-popup" id="foto-popup"></input>
                            <label class="label-popup" for="act-popup">ACTIVIDAD</label>
                            <select class="inputs-popup" name="act-popup" id="act-popup"></select>
                        </div>
                    </div>
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="alta()">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupAlta()">CANCELAR</button>
                    </div>

                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <div id="popup-modificar" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">MODIFICACIÓN</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupMod()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div id="contenido-popup">
                        <div class="entradas-popup">
                            <input type="hidden" name="modId" id="modId">
                            <label class="label-popup" for="nombre-mod">NOMBRE</label>
                            <input class="inputs-popup" type="text" id="nombre-mod" name="nombre-mod">
                            <label class="label-popup" for="desc-mod">DESCRIPCION</label>
                            <input class="inputs-popup" type="text" id="desc-mod" name="desc-mod">
                            <label class="label-popup" for="foto-mod">FOTO</label>
                            <input class="inputs-popup" type="text" id="foto-mod" name="foto-mod">
                            <label class="label-popup" for="act-mod">ACTIVIDAD ASOCIADA</label>
                            <select class="inputs-popup" name="act-mod" id="act-mod"></select>
                        </div>
                    </div>
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="modificar()">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupMod()">CANCELAR</button>
                    </div>

                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <div id="popup-baja" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">BAJA</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupBaja()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div class="texto-baja">
                        ¿ESTÁ SEGURO QUE DESEA ELIMINAR EL REGISTRO SELECCIONADO?
                    </div>
                    <input type="hidden" name="bajaId" id="bajaId">
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="baja(valuesToDelete)">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupBaja()">CANCELAR</button>
                    </div>
                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <script>

        window.onload = function () {
            comprobarChecks();
            obtenerListas();
        }

        //CONSULTA HISTORIA
        function buscarHistoria() {
            var inputId = document.getElementById('id').value;
            var inputNombre = document.getElementById('nombre').value;
            var inputDesc = document.getElementById('desc').value;
            var inputActId = document.getElementById('act_id').value;
            

            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                    if (inputId!="") {
                        formData.append('id', inputId);
                    }
                    
                    if (inputNombre!="") {
                        formData.append('historia_nombre', inputNombre);
                    }
                    
                    if (inputDesc!="") {
                        formData.append('historia_descripcion', inputNombre);
                    }
                    
                    if (inputActId!="") {
                        formData.append('actividad_id', inputNombre);
                    }
                    
                    const url = "../../api/SBconsultaHistoria.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    mostrar(data);
                    comprobarChecks();
                })
                .catch(error => console.log('Error:', error));
        }
        //ALTA

        function alta(){
            inputNombre=document.getElementById('nombre-popup').value;
            var inputDesc = document.getElementById('desc-popup').value;
            var inputFoto = document.getElementById('foto-popup').value;
            var inputActId = document.getElementById('act-popup').value;

            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('name', inputNombre);
                        
                        formData.append('desc', inputDesc);
                        
                        formData.append('image', inputFoto);
                        
                        formData.append('actid', inputActId);
                        
                    
                    const url = "../../api/SBaltaHistoria.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    buscarHistoria();
                    ocultarPopupAlta();
                    
                })
                .catch(error => console.log('Error:', error));
        }

        //Baja

        var valuesToDelete;

        function baja(valuesToDelete) {
            for (let i = 0; i < valuesToDelete.length; i++) {
                fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('id', valuesToDelete[i]);
                    
                    const url = "../../api/SBbajaHistoria.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    } else {
                        buscarHistoria();
                        ocultarPopupBaja();
                        
                    }
                })
                .catch(error => console.log('Error:', error));
                
            }
        }

        //Modificacion

        function modificar() {
                fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('id', document.getElementById('modId').value);
                        formData.append('name', document.getElementById('nombre-mod').value);
                        formData.append('desc', document.getElementById('desc-mod').value);
                        formData.append('image', document.getElementById('foto-mod').value);
                        formData.append('actid', document.getElementById('act-mod').value);
                    
                    const url = "../../api/SBupdateHistoria.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    } else {
                        buscarHistoria();
                        ocultarPopupMod();
                        
                    }
                })
                .catch(error => console.log('Error:', error));
        }

        //Mostrar popups
            //Popup alta
        function monstrarPopupAlta() {
            popupAlta = document.getElementById('popup-alta');
            popMostrar(popupAlta);
        }
        function ocultarPopupAlta(){
            popupAlta = document.getElementById('popup-alta');
            popOcultar(popupAlta);
        }
            //Popup baja

        function mostrarPopupBaja() {
            popupBaja = document.getElementById('popup-baja');
            valuesToDelete = getSelectedCheckboxes();
            console.log(valuesToDelete);
            popMostrar(popupBaja);
        }

        function ocultarPopupBaja(){
            popupBaja = document.getElementById('popup-baja');
            popOcultar(popupBaja);
        }

            //Popup modificar
        
        function mostrarPopupMod() {
            popupMod = document.getElementById('popup-modificar');
            valuesToUpdate = getSelectedCheckboxes();
            console.log(valuesToUpdate);
            getHistoria(valuesToUpdate[0]);
            
            popMostrar(popupMod);
        }

        function ocultarPopupMod(){
            popupMod = document.getElementById('popup-modificar');
            popOcultar(popupMod);
        }


        function popMostrar(element){
            element.style.display='flex';
        }

        function popOcultar(element){
            element.style.display='none';
        }

        //MOSTRAR FUNCION

        function mostrar(usuarios) {
            var cuerpo = document.getElementById("cuerpo");
            cuerpo.innerHTML = "";

            var tabla = usuarios;
            for (let i = 0; i < tabla.length; i++) {
                var tr = document.createElement("tr");

                var box = document.createElement("td");
                var check = document.createElement("input");
                check.type = "checkbox";
                check.onclick = comprobarChecks;
                check.id=tabla[i].historia_id;
                box.append(check);
                tr.append(box);
                console.log(tabla[i]);
                td1 = document.createElement("td");
                td1.innerHTML = tabla[i].historia_id;
                td2 = document.createElement("td");
                td2.innerHTML = tabla[i].historia_nombre;
                td3 = document.createElement("td");
                td3.innerHTML = tabla[i].historia_descripcion;
                td4 = document.createElement("td");
                link = document.createElement("a");
                link.href=tabla[i].historia_foto;
                link.innerHTML=tabla[i].historia_foto;
                td4.append(link);
                td5 = document.createElement("td");
                td5.innerHTML = tabla[i].actividad_id;

                tr.append(td1, td2, td3, td4, td5);
                cuerpo.append(tr);
            }
            /* asignarEventosCheckbox();
            actualizarCheckboxPrincipal(); */
        }

        //FUNCION DE CONSULTA POR ID SENCILLA

        function getHistoria(id) {
    return fetch('../../api/tokenProvider.php')
        .then(response => response.json())
        .then(data => {
            const token = data.token;
            const formData = new FormData();
            
            formData.append('grado_id', id);
            
            const url = "../../api/SBconsultaHistorias.php";
            return fetch(url, {
                method: 'POST',
                headers: {
                    'token': token
                },
                body: formData
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Response not OK: ' + response.statusText);
            }
            return response.json();  // Convertir la respuesta a JSON y devolver la promesa
        })
        .then(data => {
            asignarMod(data);
        })
        .catch(error => console.log('Error:', error));
}

function asignarMod(data) {
    document.getElementById('nombre-mod').value = data[0].historia_nombre;
    document.getElementById('modId').value = data[0].historia_id;
    document.getElementById('desc-mod').value = data[0].historia_descripcion;
    document.getElementById('foto-mod').value = data[0].historia_foto;
    document.getElementById('act-mod').value = data[0].actividad_id;
}
        //FUNCION PARA OBTENER LOS ELEMENTOS MARCADOS
        function getSelectedCheckboxes() {
            // Selecciona todos los checkboxes dentro de la tabla con id "myTable" que estén marcados
            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            var selectedValues = [];
            checkboxes.forEach(function(checkbox) {
                selectedValues.push(checkbox.id);
            });
            return selectedValues;
        }

        //Funcion para comprobar si activar los botones

        function comprobarChecks(){
            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            var botonBaja = document.getElementById('boton-baja');
            var botonMod = document.getElementById('boton-modificar');
            console.log(checkboxes);
            if (checkboxes.length==0) {
                botonBaja.disabled=true;
                botonMod.disabled=true;
            } 
            if(checkboxes.length==1){
                botonBaja.disabled=false;
                botonMod.disabled=false;
            } 
            if(checkboxes.length>=2){
                botonBaja.disabled=false;
                botonMod.disabled=true;
            }
            
        }

        function selectAll(){
            var megaCheckbox =document.getElementById('checkTodos');
            var checkboxes = document.querySelectorAll('input[type="checkbox"]');
            if (megaCheckbox.checked) {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked=true;
                    
                }
                
            } else {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked=false;
                    
                }
            }
            comprobarChecks();
        }

        function obtenerListas(){
            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                    const url = "../../api/SBconsultaActividad.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    asignarListas(data);
                    comprobarChecks();
                })
                .catch(error => console.log('Error:', error));
        }

        function asignarListas(data){
            var listaAlta = document.getElementById('act-popup');

            var listaMod = document.getElementById('act-mod');
            var listaLista = document.getElementById('act_id');
            primera = document.createElement('option');
            primera.value = "";
            primera.innerHTML = "-- selecciona una opcion --";
            listaLista.append(primera);

            for (let i = 0; i < data.length; i++) {
                
                opcionAlta = document.createElement('option');
                opcionAlta.value = data[i].Actividad_ID;
                opcionAlta.innerHTML = data[i].Actividad_nombre;

                opcionMod = document.createElement('option');
                opcionMod.value = data[i].Actividad_ID;
                opcionMod.innerHTML = data[i].Actividad_nombre;

                opcionLista = document.createElement('option');
                opcionLista.value = data[i].Actividad_ID;
                opcionLista.innerHTML = data[i].Actividad_nombre;

                listaAlta.append(opcionAlta);
                listaMod.append(opcionMod);
                listaLista.append(opcionLista);
                
            }
        }
    </script>
    <script>
        function navegar(url) {
            window.location = url;
        }
    </script>
</body>

</html>