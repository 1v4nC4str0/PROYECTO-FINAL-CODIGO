<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>ABM usuarios</title>
    <link rel="stylesheet" href="view/css/abm.css">
    <link rel="stylesheet" href="view/css/4abm.css">
</head>

<body>
    <div class="contenedor-gral">
        <div class="banner">
            <div class="logo">
                <img src="view/img/logomasEsic.png" alt="">
            </div>
            <div class="espacio"></div>
            <div class="botones-inicio-notificar">
                <a href="index.html"><button class="boton-banner">INICIO</button></a>
                <button class="boton-banner" onclick="navegar('notificar_general.php')">NOTIFICAR</button>
            </div>
        </div>
        <div class="elemento-arriba">
            <div class="componente"></div>
            <div class="rectangulo-vertical"></div>
        </div>
        <div class="nombre">
            USUARIOS
        </div>
        <div class="contenedor">
            <div class="cuerpo">
                <div class="boton-alta">
                    <button id="boton-alta" onclick="monstrarPopupAlta()" class="botones">ALTA</button>
                </div>
                <div class="entradas">

                    <input class="inputs" type="text" id="id" name="id" placeholder="ID" hidden>
                    <input class="inputs" type="text" id="nombre" name="nombre" placeholder="NOMBRE">
                    <input class="inputs" type="text" id="apellidos" name="apellidos" placeholder="APELLIDOS">
                    <input class="inputs" type="text" id="mail" name="mail" placeholder="EMAIL">
                    <input class="inputs" type="text" id="telf" name="telf" placeholder="TELEFONO">
                    <select class="inputs" name="grado" id="grado"></select>

                    <button class="lupa" onclick="buscarUsuario()"><span
                            class="material-symbols-outlined">search</span></button>
                </div>
                <div class="tabla">
                    <table id="tabla">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="checkTodos" onclick="selectAll()"></th>
                                <th class="col-id">ID</th>
                                <th class="col-nombre">NOMBRE</th>
                                <th class="col-nombre">APELLIDOS</th>
                                <th class="col-nombre">EMAIL</th>
                                <th class="col-nombre">TELEFONO</th>
                                <th class="col-nombre">GRADO</th>
                                
                            </tr>
                        </thead>
                        <tbody id="cuerpo">
                        </tbody>

                    </table>
                    <!-- <div id="errorTabla">No hay resultados</div> -->
                </div>
                <div class="botones-baja-modificacion">
                    <button class="botones" onclick="mostrarPopupBaja()" id="boton-baja">BAJA</button>
                    <button class="botones" onclick="mostrarPopupMod()" id="boton-modificar">MODIFICAR</button>
                </div>

            </div>
        </div>
        <div class="elemento-abajo" id="doss">
            <div class="componente" id="dos"></div>
            <div class="rectangulo-vertical"></div>
        </div>

    </div>
    <div id="popup-alta" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">ALTA</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupAlta()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div id="contenido-popup">
                        <div class="entradas-popup">
                            <label class="label-popup" for="nombre-popup">NOMBRE</label>
                            <input class="inputs-popup" type="text" id="nombre-popup" name="nombre-popup">
                            <label class="label-popup" for="apellidos-popup">APELLIDOS</label>
                            <input class="inputs-popup" type="text" id="apellidos-popup" name="apellidos-popup">
                            <label class="label-popup" for="mail-popup">EMAIL</label>
                            <input class="inputs-popup" type="text" id="mail-popup" name="mail-popup">
                            <label class="label-popup" for="telf-popup">TELEFONO</label>
                            <input class="inputs-popup" type="text" id="telf-popup" name="telf-popup">
                            <label class="label-popup" for="grado-popup">GRADO</label>
                            <select class="inputs-popup" name="grado-popup" id="grado-popup"></select>
                        </div>
                    </div>
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="alta()">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupAlta()">CANCELAR</button>
                    </div>

                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <div id="popup-modificar" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">MODIFICACIÓN</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupMod()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div id="contenido-popup">
                        <div class="entradas-popup">
                            <input type="hidden" name="modId" id="modId">
                            <label class="label-popup" for="nombre-mod">NOMBRE</label>
                            <input class="inputs-popup" type="text" id="nombre-mod" name="nombre-mod">
                            <label class="label-popup" for="apellidos-mod">APELLIDOS</label>
                            <input class="inputs-popup" type="text" id="apellidos-mod" name="apellidos-mod">
                            <label class="label-popup" for="mail-mod">EMAIL</label>
                            <input class="inputs-popup" type="text" id="mail-mod" name="mail-mod">
                            <label class="label-popup" for="telf">TELEFONO</label>
                            <input class="inputs-popup" type="text" id="telf-mod" name="telf-mod">
                            <label class="label-popup" for="grado-mod">GRADO</label>
                            <select class="inputs-popup" name="grado-mod" id="grado-mod"></select>
                        </div>
                    </div>
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="modificar()">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupMod()">CANCELAR</button>
                    </div>

                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <div id="popup-baja" class="popup">
        <div class="contenedor-popup">
            <div id="banner-popup">
                <div id="nombre1-popup">BAJA</div>
                <div class="espacio"></div>
                <span class="close-btn" onclick="ocultarPopupBaja()">&times;</span>
            </div>
            <div class="elemento-arriba">
                <div class="componente1"></div>
                <div class="rectangulo-vertical"></div>
            </div>
            <div class="popup-content">
                <div class="popup-cuerpo">
                    <div class="texto-baja">
                        ¿ESTÁ SEGURO QUE DESEA ELIMINAR EL REGISTRO SELECCIONADO?
                    </div>
                    <input type="hidden" name="bajaId" id="bajaId">
                    <div class="botones-baja-modificacion">
                        <button class="botones" onclick="baja(valuesToDelete)">ACEPTAR</button>
                        <button class="botones" onclick="ocultarPopupBaja()">CANCELAR</button>
                    </div>
                </div>
            </div>


            <div class="elemento-abajo" id="doss">
                <div class="componente" id="dos"></div>
                <div class="rectangulo-vertical"></div>
            </div>
        </div>
    </div>
    <script>

        window.onload = function () {
            comprobarChecks();
            obtenerListas();
        }

        //CONSULTA Usuario
        function buscarUsuario() {
            var inputId = document.getElementById('id').value;
            var inputNombre = document.getElementById('nombre').value;
            var inputApellidos = document.getElementById('apellidos').value;
            var inputMail = document.getElementById('mail').value;
            var inputTelf = document.getElementById('telf').value;
            var inputGrado = document.getElementById('grado').value;
            
            

            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                    if (inputId!="") {
                        formData.append('Usuario_id', inputId);
                    }
                    
                    if (inputNombre!="") {
                        formData.append('Usuario_Nombre', inputNombre);
                    }
                    
                    if (inputApellidos!="") {
                        formData.append('Usuario_Apellidos', inputApellidos);
                    }
                    
                    if (inputMail!="") {
                        formData.append('Usuario_Mail', inputMail);
                    }
                    
                    if (inputTelf!="") {
                        formData.append('Usuario_Telefono', xorEncrypt(inputTelf, 123897192));
                    }
                    
                    if (inputGrado!="") {
                        formData.append('Grado_id', inputGrado);
                    }
                    
                    
                    
                    const url = "../../api/SBconsultaUsuario.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    mostrar(data);
                    comprobarChecks();
                    asignarCampos();
                })
                .catch(error => console.log('Error:', error));
        }
        //ALTA

        function alta(){
            var inputNombre=document.getElementById('nombre-popup').value;
            var inputApellidos=document.getElementById('apellidos-popup').value;
            var inputMail=document.getElementById('mail-popup').value;
            var inputTelf=document.getElementById('telf-popup').value;
            var inputGrado=document.getElementById('grado-popup').value;
            var encriptado = xorEncrypt(inputTelf, 123897192);
            console.log(encriptado);

            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('usuario_nombre', inputNombre);
                        
                        formData.append('usuario_apellidos', inputApellidos);
                        
                        formData.append('usuario_mail', inputMail);
                        
                        formData.append('usuario_telefono', encriptado);
                        
                        formData.append('grado_id', inputGrado);
                        
                    
                    const url = "../../api/SBaltaUsuario.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    buscarUsuario();
                    ocultarPopupAlta();
                    
                })
                .catch(error => console.log('Error:', error));
        }

        //Baja

        var valuesToDelete;

        function baja(valuesToDelete) {
            for (let i = 0; i < valuesToDelete.length; i++) {
                fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('Usuario_id', valuesToDelete[i]);
                    
                    const url = "../../api/SBbajaUsuario.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    } else {
                        buscarUsuario();
                        ocultarPopupBaja();
                        
                    }
                })
                .catch(error => console.log('Error:', error));
                
            }
        }

        //Modificacion

        function modificar() {
                fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                
                        formData.append('Usuario_id', document.getElementById('modId').value);
                        formData.append('Usuario_Nombre', document.getElementById('nombre-mod').value);
                        formData.append('Usuario_Apellidos', document.getElementById('apellidos-mod').value);
                        formData.append('Usuario_Mail', document.getElementById('mail-mod').value);
                        formData.append('Usuario_Telefono', xorEncrypt(document.getElementById('telf-mod').value, 123897192));
                        formData.append('Grado_id', document.getElementById('grado-mod').value);
                    
                    const url = "../../api/SBupdateUsuario.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    } else {
                        buscarUsuario();
                        ocultarPopupMod();
                        
                    }
                })
                .catch(error => console.log('Error:', error));
        }

        //Mostrar popups
            //Popup alta
        function monstrarPopupAlta() {
            popupAlta = document.getElementById('popup-alta');
            popMostrar(popupAlta);
        }
        function ocultarPopupAlta(){
            popupAlta = document.getElementById('popup-alta');
            popOcultar(popupAlta);
        }
            //Popup baja

        function mostrarPopupBaja() {
            popupBaja = document.getElementById('popup-baja');
            valuesToDelete = getSelectedCheckboxes();
            console.log(valuesToDelete);
            popMostrar(popupBaja);
        }

        function ocultarPopupBaja(){
            popupBaja = document.getElementById('popup-baja');
            popOcultar(popupBaja);
        }

            //Popup modificar
        
        function mostrarPopupMod() {
            popupMod = document.getElementById('popup-modificar');
            valuesToUpdate = getSelectedCheckboxes();
            console.log(valuesToUpdate);
            getUsuario(valuesToUpdate[0]);
            
            popMostrar(popupMod);
        }

        function ocultarPopupMod(){
            popupMod = document.getElementById('popup-modificar');
            popOcultar(popupMod);
        }


        function popMostrar(element){
            element.style.display='flex';
        }

        function popOcultar(element){
            element.style.display='none';
        }

        //MOSTRAR FUNCION

        function mostrar(usuarios) {
            var cuerpo = document.getElementById("cuerpo");
            cuerpo.innerHTML = "";

            var tabla = usuarios;
            for (let i = 0; i < tabla.length; i++) {
                var tr = document.createElement("tr");

                var box = document.createElement("td");
                var check = document.createElement("input");
                check.type = "checkbox";
                check.onclick = comprobarChecks;
                check.id=tabla[i].Usuario_id;
                box.append(check);
                tr.append(box);
                console.log(tabla[i]);
                td1 = document.createElement("td");
                td1.innerHTML = tabla[i].Usuario_id;
                td2 = document.createElement("td");
                td2.innerHTML = tabla[i].Usuario_Nombre;
                td3 = document.createElement("td");
                td3.innerHTML = tabla[i].Usuario_Apellidos;
                td4 = document.createElement("td");
                td4.innerHTML = tabla[i].Usuario_Mail;
                td5 = document.createElement("td");
                td5.innerHTML = xorDecrypt(tabla[i].Usuario_Telefono, 123897192);
                td6 = document.createElement("td");
                td6.classList.add("cambiar");
                td6.innerHTML = tabla[i].Grado_id;

                tr.append(td1, td2, td3, td4, td5, td6);
                cuerpo.append(tr);
            }
            /* 123897192 asignarEventosCheckbox();
            actualizarCheckboxPrincipal(); */
        }

        //FUNCION DE CONSULTA POR ID SENCILLA

        function getUsuario(id) {
    return fetch('../../api/tokenProvider.php')
        .then(response => response.json())
        .then(data => {
            const token = data.token;
            const formData = new FormData();
            
            formData.append('Usuario_id', id);
            
            const url = "../../api/SBconsultaUsuario.php";
            return fetch(url, {
                method: 'POST',
                headers: {
                    'token': token
                },
                body: formData
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Response not OK: ' + response.statusText);
            }
            return response.json();  // Convertir la respuesta a JSON y devolver la promesa
        })
        .then(data => {
            asignarMod(data);
        })
        .catch(error => console.log('Error:', error));
}

function asignarMod(data) {
    telefonoDesencriptado = xorDecrypt(data[0].Usuario_Telefono, 123897192);
    document.getElementById('nombre-mod').value = data[0].Usuario_Nombre;
    document.getElementById('modId').value = data[0].Usuario_id;
    document.getElementById('apellidos-mod').value = data[0].Usuario_Apellidos;
    document.getElementById('mail-mod').value = data[0].Usuario_Mail;
    document.getElementById('telf-mod').value = telefonoDesencriptado;
    document.getElementById('grado-mod').value = data[0].Grado_id;
}
        //FUNCION PARA OBTENER LOS ELEMENTOS MARCADOS
        function getSelectedCheckboxes() {
            // Selecciona todos los checkboxes dentro de la tabla con id "myTable" que estén marcados
            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            var selectedValues = [];
            checkboxes.forEach(function(checkbox) {
                selectedValues.push(checkbox.id);
            });
            return selectedValues;
        }

        //Funcion para comprobar si activar los botones

        function comprobarChecks(){
            var checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            var botonBaja = document.getElementById('boton-baja');
            var botonMod = document.getElementById('boton-modificar');
            console.log(checkboxes);
            if (checkboxes.length==0) {
                botonBaja.disabled=true;
                botonMod.disabled=true;
            } 
            if(checkboxes.length==1){
                botonBaja.disabled=false;
                botonMod.disabled=false;
            } 
            if(checkboxes.length>=2){
                botonBaja.disabled=false;
                botonMod.disabled=true;
            }
            
        }

        function selectAll(){
            var megaCheckbox =document.getElementById('checkTodos');
            var checkboxes = document.querySelectorAll('input[type="checkbox"]');
            if (megaCheckbox.checked) {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked=true;
                    
                }
                
            } else {
                for (let i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked=false;
                    
                }
            }
            comprobarChecks();
        }

        function asignarCampos(){
            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                    const url = "../../api/SBconsultaGrado.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    asignarDatos(data);
                    comprobarChecks();
                })
                .catch(error => console.log('Error:', error));
        }

        function asignarDatos(data){
            // Obteniendo los elementos con el ID "cambio"
            const cambios = document.querySelectorAll("#cambiar");

            // Iterando sobre los elementos
            cambios.forEach(elemento => {
                // Obteniendo el ID del elemento
                const id = elemento.innerHTML;
                // Buscando el tipo grado en los datos proporcionados
                const tipoGrado = data.find(item => item.grado_id === id)?.grado_nombre;
                // Asignando el nombre del tipo grado como innerHTML
                if (tipoGrado) {
                    elemento.innerHTML = tipoGrado;
                } else {
                    elemento.innerHTML = "Tipo de grado no encontrado";
                }
            });
        }

        function obtenerListas(){
            fetch('../../api/tokenProvider.php')
                .then(response => response.json())
                .then(data => {
                    const token = data.token;
                    const formData = new FormData();
                    const url = "../../api/SBconsultaGrado.php";
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'token': token
                        },
                        body: formData
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Response not OK: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    asignarListas(data);
                    comprobarChecks();
                })
                .catch(error => console.log('Error:', error));
        }

        function asignarListas(data){
            var listaAlta = document.getElementById('grado-popup');

            var listaMod = document.getElementById('grado-mod');

            var listaLista = document.getElementById('grado');

            primera = document.createElement('option');
            primera.value = "";
            primera.innerHTML = "-- selecciona una opcion --";
            listaLista.append(primera);

            for (let i = 0; i < data.length; i++) {
                
                opcionAlta = document.createElement('option');
                opcionAlta.value = data[i].grado_id;
                opcionAlta.innerHTML = data[i].grado_Nombre;

                opcionMod = document.createElement('option');
                opcionMod.value = data[i].grado_id;
                opcionMod.innerHTML = data[i].grado_Nombre;

                opcionLista = document.createElement('option');
                opcionLista.value = data[i].grado_id;
                opcionLista.innerHTML = data[i].grado_Nombre;

                listaAlta.append(opcionAlta);
                listaMod.append(opcionMod);
                listaLista.append(opcionLista);
                
            }
        }
        function xorDecrypt(telefonoEncriptado, claveSecreta) {
            let telefonoDesencriptado = (parseInt(telefonoEncriptado) ^ claveSecreta).toString();
            return telefonoDesencriptado;
        }
        function xorEncrypt(telefono, claveSecreta) {
            let telefonoEncriptado = (parseInt(telefono) ^ claveSecreta).toString();
            return telefonoEncriptado;
        }
    </script>
    <script>
        function navegar(url) {
            window.location = url;
        }
    </script>
</body>

</html>